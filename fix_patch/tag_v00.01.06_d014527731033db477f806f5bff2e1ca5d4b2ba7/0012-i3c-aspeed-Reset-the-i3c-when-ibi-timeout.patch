From 214586947d267635aa4a2c4db7eecc2cfa111c43 Mon Sep 17 00:00:00 2001
From: SaraLin-wiwynn <Sara_SY_Lin@wiwynn.com>
Date: Wed, 11 Jan 2023 14:14:47 +0800
Subject: [PATCH] driver: i3c: aspeed: i3c-aspeed-Reset-the-i3c-when-ibi-timeout

---
 drivers/i3c/i3c_aspeed.c | 11 ++++++++++-
 1 file changed, 10 insertions(+), 1 deletion(-)

diff --git a/drivers/i3c/i3c_aspeed.c b/drivers/i3c/i3c_aspeed.c
index ac56d67b99..4d20f93e32 100644
--- a/drivers/i3c/i3c_aspeed.c
+++ b/drivers/i3c/i3c_aspeed.c
@@ -547,6 +547,7 @@ struct i3c_aspeed_obj {
 #define DEV_CFG(dev)			((struct i3c_aspeed_config *)(dev)->config)
 #define DEV_DATA(dev)			((struct i3c_aspeed_obj *)(dev)->data)
 #define DESC_PRIV(desc)			((struct i3c_aspeed_dev_priv *)(desc)->priv_data)
+static int i3c_aspeed_init(const struct device *dev);
 
 static uint8_t *pec_append(const struct device *dev, uint8_t *ptr, uint8_t len)
 {
@@ -1408,6 +1409,7 @@ int i3c_aspeed_slave_put_read_data(const struct device *dev, struct i3c_slave_pa
 	union i3c_device_cmd_queue_port_s cmd;
 	uint8_t *xfer_buf;
 	union i3c_reset_ctrl_s reset_ctrl;
+	int flag_ret;
 
 	__ASSERT_NO_MSG(data);
 	__ASSERT_NO_MSG(data->buf);
@@ -1455,8 +1457,13 @@ int i3c_aspeed_slave_put_read_data(const struct device *dev, struct i3c_slave_pa
 	i3c_register->cmd_queue_port.value = cmd.value;
 
 	if (ibi_notify) {
+		k_busy_wait(100);
 		i3c_register->i3c_slave_intr_req.fields.sir = 1;
-		osEventFlagsWait(obj->ibi_event, events.value, osFlagsWaitAll, osWaitForever);
+		flag_ret = osEventFlagsWait(obj->ibi_event, events.value, osFlagsWaitAll, 10);
+		if (flag_ret == osFlagsErrorTimeout) {
+			i3c_aspeed_init(dev);
+			printk("Reset the I3c controller to avoid IBI storm\n");
+		}
 	}
 	i3c_aspeed_slave_wait_data_consume(dev);
 	k_busy_wait(100);
@@ -1661,6 +1668,7 @@ static int i3c_aspeed_init(const struct device *dev)
 
 	obj->dev = dev;
 	obj->config = config;
+	reset_control_assert(reset_dev, config->reset_id);
 	clock_control_on(config->clock_dev, config->clock_id);
 	reset_control_deassert(reset_dev, config->reset_id);
 
@@ -1682,6 +1690,7 @@ static int i3c_aspeed_init(const struct device *dev)
 
 	i3c_register->intr_status.value = GENMASK(31, 0);
 	intr_reg.value = 0;
+	intr_reg.fields.xfr_abort = 1;
 	intr_reg.fields.xfr_error = 1;
 	intr_reg.fields.resp_q_ready = 1;
 
-- 
2.24.1

